# Arquitectura de Alto Nivel

Este documento detalla la arquitectura t√©cnica del sistema, componentes principales, diagrama de flujo y especificaci√≥n de endpoints. Dise√±ado para ser replicable por otro sistema de IA o equipo de desarrollo.

## 1. Diagrama de Arquitectura

```mermaid
graph TD
    User((Usuario üë§)) -->|Mensaje WhatsApp| WA[WhatsApp API üü¢]
    WA -->|Webhook POST /webhook| API[NestJS API üõ°Ô∏è]
    
    subgraph "Backend System"
        API -->|1. Procesa Mensaje| Agent[Gemini AI Agent ü§ñ]
        Agent <-->|2. Consulta/Acci√≥n| API_Internal[Internal Services]
        
        API_Internal -->|Leer/Escribir| DB[(PostgreSQL Database üóÑÔ∏è)]
        
        API_Internal -->|Productos| Mod_Prod[M√≥dulo Productos]
        API_Internal -->|Carritos| Mod_Cart[M√≥dulo Carritos]
    end

    Agent -->|3. Genera Respuesta| API
    API -->|Respuesta Texto| WA
    WA -->|Mensaje| User
```

## 2. Componentes Principales

### **1. LLM / Agente de IA (Gemini)**
- **Motor:** Google Gemini 2.5 Flash.
- **Responsabilidad:** Interpretar la intenci√≥n del usuario (buscar productos, comprar, ver carrito) y ejecutar herramientas (‚ÄúTools‚Äù) para interactuar con el backend.
- **Personalidad:** Experto en ventas, c√°lido y emp√°tico.

### **2. API REST (NestJS)**
- **Framework:** NestJS (Modular).
- **Responsabilidad:** Orquestar la l√≥gica de negocio, exponer endpoints para el webhook de WhatsApp y proveer acceso a datos para el Agente.
- **Estructura:** Modular (`src/modules/*`), separando dominios como `products`, `carts`, `whatsapp`.

### **3. Base de Datos (PostgreSQL)**
- **ORM:** TypeORM.
- **Entidades Principales:**
    - [`Product`](../src/products/entities/product.entity.ts): Cat√°logo de inventario
    - [`Cart`](../src/carts/entities/cart.entity.ts): Sesi√≥n de compra del usuario
    - [`CartItem`](../src/carts/entities/cart-item.entity.ts): Relaci√≥n producto-cantidad en un carrito

### **4. Servicios Externos**
- **WhatsApp (Twilio/Meta):** Canal de comunicaci√≥n con el cliente.
- **Google Generative AI:** Proveedor del modelo de inteligencia artificial.

---

## 3. Especificaci√≥n de Endpoints

### üõí M√≥dulo Carritos (`/carts`)
| M√©todo | Endpoint | Descripci√≥n | Payload / Params |
| :--- | :--- | :--- | :--- |
| `GET` | `/carts/user/:userId` | Obtiene el carrito activo de un usuario. | `userId`: string (tel√©fono) |
| `POST` | `/carts/add-item` | Agrega un producto al carrito o actualiza cantidad. | `{ userId, productId, qty }` |
| `PATCH` | `/carts/:id` | Modifica un √≠tem espec√≠fico en el carrito. | `{ productId, qty }` |

### üõçÔ∏è M√≥dulo Productos (`/products`)
| M√©todo | Endpoint | Descripci√≥n | Payload / Params |
| :--- | :--- | :--- | :--- |
| `GET` | `/products` | Busca productos con filtros (b√∫squeda sem√°ntica/texto). | `?q=termino` |
| `GET` | `/products/:id` | Obtiene detalle de un producto espec√≠fico. | `id`: number |
| `GET` | `/products/seed/run` | (Dev) Poblar base de datos desde Excel. | N/A |

### üü¢ M√≥dulo WhatsApp (`/whatsapp`)
| M√©todo | Endpoint | Descripci√≥n | Payload / Params |
| :--- | :--- | :--- | :--- |
| `POST` | `/whatsapp/webhook` | Recibe mensajes entrantes de WhatsApp. | JSON Webhook Twilio |

---

## 4. Flujo de Interacci√≥n del Agente

Ver documento detallado en: [flow_map.md](./flow_map.md)

### Resumen del Flujo

1. **Recepci√≥n:** El mensaje llega al `WhatsappController` (src/whatsapp/whatsapp.controller.ts).
2. **Procesamiento:** El `AiService` (src/ai/ai.service.ts) recibe el texto y lo env√≠a al `GeminiAgent` (src/ai/gemini.agent.ts).
3. **Razonamiento:** El LLM decide si responder con texto puro o llamar a una herramienta (`getProducts`, `addToCart`).
4. **Ejecuci√≥n:**
   - Si llama a una herramienta: El agente hace una petici√≥n HTTP a la API de NestJS.
   - La API consulta la base de datos y devuelve el JSON.
5. **Respuesta:** El LLM toma el JSON, lo formatea con "tacto comercial" y devuelve la respuesta final al usuario v√≠a WhatsApp.

